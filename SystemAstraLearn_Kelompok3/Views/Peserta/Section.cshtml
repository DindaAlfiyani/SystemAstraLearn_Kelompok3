@{
    ViewData["Title"] = "Pelatih - Pelatihan";
    Layout = "_LayoutSection";
}

<input type="hidden" id="idPelatihan" value="@ViewBag.idPelatihan" />
<input type="hidden" id="namaPelatihan" value="@ViewBag.namaPelatihan" />
<input type="hidden" id="idSection" value="@ViewBag.idSection" />

<section id="breadcrumbs" class="breadcrumbs" style="background-color: whitesmoke; border-radius: 15px; height: 900px; width: 1300px; margin-left: 30px;">
    <div class="container-fluid">
        <!-- Video YouTube -->
        <div class="nama-container">
            <h1 id="namaSection" class="display-4 mb-4" style="color: #006CBB; font-weight: bold; padding-top: 5px;"></h1>
        </div>
        <div class="video-container">
            <iframe id="videoContainer" width="560" height="315" src="" frameborder="0" allowfullscreen style="border-radius: 15px; height: 555px; width: 1100px;"></iframe>
            <div class="desk-container" style="border-radius: 15px; padding-top: 600px;">
                <p id="deskripsiSection" class="lead mb-4" style="max-width: 1800px; word-wrap: break-word;" style="font-weight: bold;"></p>
            </div>
            <div class="button-container mt-3">
                <button class="btn btn-danger modul-btn" style="background-color: #006CBB; border-radius: 10px; font-size: 20px;">
                    Unduh Modul <i class="bi bi-arrow-down-circle-fill"></i>
                </button>
                <button class="btn btn-secondary update-href-btn" style="background-color: dodgerblue; border-radius: 10px; font-size: 20px;">Exercise</button>
                <button class="btn btn-secondary lanjut-btn" style="background-color: #483D8B; border-radius: 10px; font-size: 20px;">Lanjutkan<i class='bi bi-arrow-right'></i></button>
            </div>
        </div>

    </div>
</section>

<style>
    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

    .pdf-container {
        width: 100%;
        max-width: 800px;
        margin-top: 20px;
    }

    /* Additional styles for larger headers and text */
    h2.display-4 {
        font-size: 2.5rem; /* Adjust the font size as needed */
    }

    p.lead {
        font-size: 1.25rem; /* Adjust the font size as needed */
    }

    .button-container {
        margin-bottom: 40px; /* Sesuaikan dengan seberapa besar ruang yang diinginkan */
    }

    .nama-container {
        color: dodgerblue;
        margin-top: 40px;
        margin-bottom: 40px; /* Sesuaikan dengan seberapa besar ruang yang diinginkan */
    }

    .desk-container {
        margin-top: 40px;
        margin-bottom: 40px; /* Sesuaikan dengan seberapa besar ruang yang diinginkan */
    }

    .btn-danger {
        color: #fff; /* Warna teks */
        background-color: #dc3545; /* Warna latar belakang - merah */
        border-color: #dc3545; /* Warna border - merah */
    }

    .btn-primary {
        color: #fff; /* Warna teks */
        background-color: #007bff; /* Warna latar belakang - biru */
        border-color: #007bff; /* Warna border - biru */
    }
</style>

<script>
    $(document).ready(function () {
        var rootHost = "http://localhost:5114";
        var rootWebHost = "https://localhost:7275/MengikutiPelatihan/";
        var rootWebHost2 = "https://localhost:7275/MengerjakanExercise/"
        var IdPelatihan = $("#idPelatihan").val();
        var IdSection = $("#idSection").val();
        var NamaPelatihan = $("#namaPelatihan").val();
        var NamaPengguna = $("#namaPengguna").val();;
        var rootWebHost3 = "https://localhost:7275/MengerjakanExam/";
        var idBerikutnya;
        var NamaModul;
        var RiwayatSection;
        var HistorySection;
        var IdLogin = $("#idLogin").val()
        var video = "https://localhost:7275/assets/Video/";
        var pdfDirectory = "https://localhost:7275/assets/Upload/";

        var elem = $(IdSection);

        // Periksa apakah elemen tersebut ada dan memiliki kelas 'bi-check-circle-fill'
        /* if (elem.hasClass("bi-check-circle-fill")) {
             // Jalankan sesuatu jika kelas ada
             console.log("Kelas bi-check-circle-fill ditemukan");
         } else {
             // Jalankan sesuatu jika kelas tidak ada
             console.log("Kelas bi-check-circle-fill tidak ditemukan");
         }*/

        function loadForm() {
            $.ajax({
                url: rootHost + '/Section/GetSection?id=' + IdSection,
                method: 'get',
                contentType: 'application/json',
                success: function (response) {
                    if (response.status === 200) {
                        var data = response.data;

                        // Update the HTML elements with the received data
                        $("#namaSection").text(data.nama_section);
                        $("#videoContainer").attr("src", video + data.video_pembelajaran);
                        $("#deskripsiSection").text(data.deskripsi);
                        NamaModul = data.modul_pembelajaran;

                        $("#videoContainer").on("ended", function () {
                            console.log("Video selesai diputar");
                            $(".lanjut-btn").show();
                        });
                    } else {
                        console.error("Failed to load section data.");
                    }
                },
                error: function () {
                    console.error("Failed to load section data.");
                }
            });
        }


        $(document).on("click", ".update-href-btn", function () {
            var newHref = rootWebHost2 + IdPelatihan + '/' + IdSection + '/' + NamaPelatihan;
            window.location.href = newHref;
        });

        function loadVidio() {
            console.log('b');
            var video = document.getElementById('videoContainer');
            console.log('a');
            console.log(video);

            // Periksa apakah video telah dimuat sebelum mencoba mengakses currentTime
            if (video && video.readyState >= 2 && video.currentTime >= video.duration - 1) {
                console.log("Video hampir selesai");
                $(".lanjut-btn").show();
            }
        }

        function tryLoadVidio() {
            var video = document.getElementById('videoContainer');
            if (video && video.readyState >= 2) {
                loadVidio();
            } else {
                // Jika video belum sepenuhnya dimuat, tunggu hingga dimuat sebelum mencoba lagi
                video.addEventListener('loadeddata', function () {
                    tryLoadVidio();
                });
            }
        }

        function loadDataEverySecond() {
            tryLoadVidio(); // Panggil pertama kali saat halaman dimuat
            setInterval(tryLoadVidio, 1000); // Set interval untuk memanggil tryLoadVidio setiap 1000 milliseconds (1 detik)
        }

        function loadRiwayat() {
            $.ajax({
                url: rootHost + '/MengikutiPelatihan/GetMengikutiPelatihan?id_pengguna=' + IdLogin + '&id_pelatihan=' + IdPelatihan,
                method: 'get',
                contentType: 'application/json',
                success: function (response) {
                    RiwayatSection = response.data.riwayat_section;
                    console.log(RiwayatSection);
                    if (RiwayatSection !== undefined && !isNaN(RiwayatSection)) {
                        loadId(parseInt(RiwayatSection)); // Perbarui riwayat dengan nilai yang tepat
                    } else {
                        console.error("Invalid riwayat section index.");
                    }
                },
                error: function () {
                    console.error("Failed to load sections data.");
                }
            });
        }

        function loadId(riwayat) {
            // Lakukan pengecekan apakah semua section telah selesai
            $.ajax({
                url: rootHost + '/Section/GetAllSectionsById?id=' + IdPelatihan + '&status=1',
                method: 'get',
                contentType: 'application/json',
                success: function (response) {
                    if (response.status === 200) {
                        if (!response.data || !Array.isArray(response.data)) {
                            console.error("Data section tidak valid.");
                            return;
                        }

                        // Jika riwayat melebihi jumlah section, arahkan ke halaman exam
                        if (riwayat >= response.data.length) {
                            window.location.href = rootWebHost3 + IdPelatihan + '/' + IdSection + '/' + NamaPelatihan;
                            return;
                        }

                        // Jika belum semua section selesai, lanjutkan ke section berikutnya
                        var nextSection = response.data[riwayat];
                        if (!nextSection) {
                            console.error("Section berikutnya tidak ditemukan.");
                            return;
                        }
                        console.log('Next Section' + nextSection.id_section);
                        //return;
                        idBerikutnya = nextSection.id_section;
                        var newHref = rootWebHost + IdPelatihan + '/' + idBerikutnya + '/' + NamaPelatihan;
                        window.location.href = newHref;
                    } else {
                        console.error("Gagal memuat data section.");
                    }
                },
                error: function () {
                    console.error("Gagal memuat data section.");
                }
            });
        }



        $(document).on("click", ".lanjut-btn", function () {
            var namaPelatihan = $("#namaSection").text(); // Ambil teks dari elemen dengan ID namaSection

            var data = {
                id_mengikuti_pelatihan: 0,
                id_pengguna: IdLogin,
                id_pelatihan: IdPelatihan,
                riwayat_section: 0,
                tanggal_mulai: new Date(),
                tanggal_selesai: new Date(),
                status: 1
            };

            console.log(data);

            $.ajax({
                url: rootHost + "/MengikutiPelatihan/UpdateMengikutiPelatihan",
                type: "post",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json",
                success: function (result) {
                    loadRiwayat();
                },
                error: function () {
                    console.error("Error fetching data.");
                }
            });
        });

        $(document).on("click", ".modul-btn", function () {
            var pdfUrl = pdfDirectory + NamaModul;
            window.open(pdfUrl, '_blank');
        });

        loadForm();
        loadDataEverySecond();
    });
</script>